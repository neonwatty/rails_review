service: receivers
frameworkVersion: '3'
useDotenv: true

provider:
  name: aws
  stage: ${opt:stage, 'test'}
  region: ${env:AWS_REGION}
  profile: ${env:AWS_PROFILE}
  runtime: python3.10
  timeout: 240
  architecture: arm64
  stackTags:
    product: receiver-functions
    customer-impact: true
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - s3:*
          Resource:
            - arn:aws:s3:::${env:APP_NAME}-${opt:stage, 'test'}
            - arn:aws:s3:::${env:APP_NAME}-${opt:stage, 'test'}/*
            - arn:aws:s3:::${env:APP_NAME}-trigger
            - arn:aws:s3:::${env:APP_NAME}-trigger/*
        - Effect: Allow
          Action:
            - sqs:*
          Resource: "*"
  deploymentBucket:
    name: ${env:APP_NAME}-serverless-artifacts
  environment:
    APP_NAME: ${env:APP_NAME}
    STAGE: ${opt:stage, 'test'}

functions:
  receiver_start:
    name: ${env:APP_NAME}-receiver_start-${opt:stage, 'test'}
    image: ${env:ACCOUNT_ID}.dkr.ecr.us-west-2.amazonaws.com/${env:APP_NAME}-receiver_start:${opt:stage, 'test'}
    description: 'test rails receiver lambda function'
    environment:
      RECEIVER_NAME: receiver_start

  receiver_preprocess:
    name: ${env:APP_NAME}-receiver_preprocess-${opt:stage, 'test'}
    image: ${env:ACCOUNT_ID}.dkr.ecr.us-west-2.amazonaws.com/${env:APP_NAME}-receiver_preprocess:${opt:stage, 'test'}
    description: 'receiver preprocess lambda function'
    events:
      - sqs:
          arn: ${env:SQS_ARN_ROOT}${env:APP_NAME}-receiver_preprocess
          batchSize: 1
    environment:
      RECEIVER_NAME: receiver_preprocess

  receiver_process:
    name: ${env:APP_NAME}-receiver_process-${opt:stage, 'test'}
    image: ${env:ACCOUNT_ID}.dkr.ecr.us-west-2.amazonaws.com/${env:APP_NAME}-receiver_process:${opt:stage, 'test'}
    description: 'receiver process lambda function'
    events:
      - sqs:
          arn: ${env:SQS_ARN_ROOT}${env:APP_NAME}-receiver_process
          batchSize: 1
    environment:
      RECEIVER_NAME: receiver_process

  receiver_end:
    name: ${env:APP_NAME}-receiver_end-${opt:stage, 'test'}
    image: ${env:ACCOUNT_ID}.dkr.ecr.us-west-2.amazonaws.com/${env:APP_NAME}-receiver_end:${opt:stage, 'test'}
    description: 'receiver end lambda function'
    events:
      - sqs:
          arn: ${env:SQS_ARN_ROOT}${env:APP_NAME}-receiver_end
          batchSize: 1
    environment:
      RECEIVER_NAME: receiver_end
      RAILS_DEVELOPMENT_HOST: ${env:RAILS_DEVELOPMENT_HOST}
      LAMBDA_API_KEY: ${env:LAMBDA_API_KEY}

  receiver_status:
    name: ${env:APP_NAME}-receiver_status-${opt:stage, 'test'}
    image: ${env:ACCOUNT_ID}.dkr.ecr.us-west-2.amazonaws.com/${env:APP_NAME}-receiver_status:${opt:stage, 'test'}
    description: 'receiver status lambda function'
    events:
      - sqs:
          arn: ${env:SQS_ARN_ROOT}${env:APP_NAME}-receiver_status
          batchSize: 1
    environment:
      RECEIVER_NAME: receiver_status
      RAILS_DEVELOPMENT_HOST: ${env:RAILS_DEVELOPMENT_HOST}
      LAMBDA_API_KEY: ${env:LAMBDA_API_KEY}