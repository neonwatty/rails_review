service: entrypoints
frameworkVersion: '3'
useDotenv: true

provider:
  name: aws
  stage: ${opt:stage, 'dev'}
  region: ${env:AWS_REGION}
  profile: ${env:AWS_PROFILE}
  runtime: python3.10
  timeout: 240
  architecture: arm64
  stackTags:
    product: entrypoint-functions
    customer-impact: true
  iamRoleStatements:
    - Effect: Allow
      Action:
        - dynamodb:ListTables
        - dynamodb:DescribeTable
        - dynamodb:GetItem
        - dynamodb:Query
      Resource: "*"
    - Effect: Allow
      Action:
        - s3:ListBucket
        - s3:getObject
        - s3:putObject
      Resource:
        - arn:aws:s3:::${env:BUCKET_MAIN}
        - arn:aws:s3:::${env:BUCKET_MAIN}/*
        - arn:aws:s3:::${env:BUCKET_TEST}
        - arn:aws:s3:::${env:BUCKET_TEST}/*
        - arn:aws:s3:::${env:BUCKET_TRIGGER}
        - arn:aws:s3:::${env:BUCKET_TRIGGER}/*
  deploymentBucket:
    name: promo-serverless-artifacts
  deploymentPrefix: ${self:service}
  environment:
    STAGE: ${opt:stage, 'dev'}
    QUEUE_TEST: ${env:QUEUE_TEST}
    BUCKET_MAIN: ${env:BUCKET_MAIN}
    BUCKET_TEST: ${env:BUCKET_TEST}
    BUCKET_TRIGGER: ${env:BUCKET_TRIGGER}
    SUPABASE_URL: ${env:SUPABASE_URL}
    SUPABASE_KEY: ${env:SUPABASE_KEY}
    HISTORY_LEDGER_MAIN: ${env:HISTORY_LEDGER_MAIN}
    FILE_LEDGER_TEMP: ${env:FILE_LEDGER_TEMP}
    FILE_LEDGER_MAIN: ${env:FILE_LEDGER_MAIN}


functions:
  entrypoint_input:
    image: ${env:ACCOUNT_ID}.dkr.ecr.us-west-2.amazonaws.com/entrypoint_input:${opt:stage, 'dev'}
    description: 'entrypoint input lambda function'

  entrypoint_output:
    image: ${env:ACCOUNT_ID}.dkr.ecr.us-west-2.amazonaws.com/entrypoint_output:${opt:stage, 'dev'}
    description: 'entrypoint output lambda function'

  entrypoint_status:
    image: ${env:ACCOUNT_ID}.dkr.ecr.us-west-2.amazonaws.com/entrypoint_status:${opt:stage, 'dev'}
    description: 'entrypoint status lambda function'

  entrypoint_delete:
    image: ${env:ACCOUNT_ID}.dkr.ecr.us-west-2.amazonaws.com/entrypoint_delete:${opt:stage, 'dev'}
    description: 'entrypoint delete lambda function'
